<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summoner Stats</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAARUVFAACz/wAUFBQAKysrAICAgAD/XgAAAAD/AAD/NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFVQAAVVAAAFVVUAVXdQAFVVVVVVd1UAVVRVVVImZQBVREVVUiZlAFVUVVVViFUAVVVRVRWIVQAFVVVVVVVQAAREADAAREAAAAAAAwAAAAAAAAADAAAAAAAAADAAAAAAAAADAAAAAAAAAAMAAAAAD//wAA//8AAOPHAADBgwAAgAEAAIABAACAAQAAgAEAAIABAADAAwAAxuMAAP9/AAD/fwAA/v8AAP3/AAD9/wAA" rel="icon" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #fff;
            color: #4a5568;
            font-family: 'Cabinet Grotesk', sans-serif;
        }
        .container {
            margin-top: 20px;
        }
        .stat-card {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            border-radius: 1rem;
        }
        .list-group-item {
            background-color: #fff;
            border-color: #e2e8f0;
            color: #4a5568;
        }
        .list-group-item-success {
            background-color: #f0fff4 !important;
            color: #2f855a !important;
        }
        .list-group-item-danger {
            background-color: #fff5f5 !important;
            color: #c53030 !important;
        }
        .clickable-row {
            cursor: pointer;
        }
        .list-group-item:hover, .clickable-row:hover {
            background-color: #edf2f7 !important;
        }
        .rank-crest-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto;
        }
        .rank-crest, .tier-wing, .wing {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .item-icon {
            width: 32px;
            height: 32px;
            margin-right: 2px;
        }
        .champion-icon {
            width: 32px;
            height: 32px;
            vertical-align: middle;
        }
        .champion-icon-map {
            position: absolute;
            width: 24px;
            height: 24px;
            border: 2px solid;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .sortable-header {
            cursor: pointer;
        }
        .nav-tabs .nav-link {
            color: #4a5568;
            background-color: #fff;
            border-color: #e2e8f0;
        }
        .nav-tabs .nav-link.active {
            color: #2b6cb0;
            background-color: #ebf8ff;
            border-color: #bee3f8;
        }
        .table {
            color: #4a5568;
        }
        .table-hover > tbody > tr:hover > * {
            color: #2d3748;
            background-color: #edf2f7;
        }
        .modal-content {
            background-color: #fff;
            color: #4a5568;
        }
        .modal-header {
            border-bottom-color: #e2e8f0;
        }
        .btn-close {
            filter: none;
        }
        .form-select, .form-control {
            background-color: #fff;
            color: #4a5568;
            border-color: #e2e8f0;
        }
        .form-select:focus, .form-control:focus {
            background-color: #fff;
            color: #4a5568;
            border-color: #a0aec0;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Summoner Analytics</h1>
        <div id="loading" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading all your data...</p>
        </div>
        <div id="content" class="d-none">
            <!-- Player and General Stats -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Player</h5>
                            <p id="player-name" class="card-text fs-4"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Games Analyzed</h5>
                            <p id="total-games" class="card-text fs-4"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stat-card">
                        <div class="card-body text-center">
                            <h5 class="card-title">Overall Win Rate</h5>
                            <p id="win-rate" class="card-text fs-4"></p>
                        </div>
                    </div>
                </div>
            </div>
             <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">Dashboard</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="champion-performance-tab" data-bs-toggle="tab" data-bs-target="#champion-performance" type="button" role="tab" aria-controls="champion-performance" aria-selected="false">Champion Performance</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="match-history-tab" data-bs-toggle="tab" data-bs-target="#match-history" type="button" role="tab" aria-controls="match-history" aria-selected="false">Match History</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="mini-map-tab" data-bs-toggle="tab" data-bs-target="#mini-map" type="button" role="tab" aria-controls="mini-map" aria-selected="false">Mini-map</button>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                    <div class="row mt-3">
                        <div class="col-lg-8">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Ranked Stats</h5>
                                    <div class="row" id="ranked-stats">
                                        <!-- Ranked info will be populated here -->
                                    </div>
                                </div>
                            </div>
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Recent 20 Games Trend</h5>
                                    <canvas id="win-loss-chart"></canvas>
                                </div>
                            </div>
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Gold per Minute (Last 20 Games)</h5>
                                    <canvas id="gpm-trend-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Role Distribution</h5>
                                    <canvas id="role-distribution-chart"></canvas>
                                </div>
                            </div>
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Win Rate by Game Type</h5>
                                    <canvas id="gamemode-winrate-chart"></canvas>
                                </div>
                            </div>
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Average Damage Composition</h5>
                                    <canvas id="damage-composition-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Top 5 Champions by Win Rate</h5>
                                    <canvas id="top-champs-winrate-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <h5 class="card-title">Top 5 Champions by KDA</h5>
                                    <canvas id="top-champs-kda-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="champion-performance" role="tabpanel" aria-labelledby="champion-performance-tab">
                    <div class="card stat-card mt-3">
                        <div class="card-body">
                            <h5 class="card-title">Champion Performance</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="sortable-header" data-sort="name">Champion <i class="bi bi-sort-alpha-down"></i></th>
                                            <th class="sortable-header" data-sort="games">Games <i class="bi bi-sort-down"></i></th>
                                            <th class="sortable-header" data-sort="winRate">Win Rate <i class="bi bi-sort-down"></i></th>
                                            <th class="sortable-header" data-sort="kda">Avg. KDA <i class="bi bi-sort-down"></i></th>
                                            <th class="sortable-header" data-sort="masteryLevel">Mastery Level <i class="bi bi-sort-down"></i></th>
                                            <th class="sortable-header" data-sort="masteryPoints">Mastery Points <i class="bi bi-sort-down"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody id="champion-stats-table">
                                        <!-- Champion stats will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="match-history" role="tabpanel" aria-labelledby="match-history-tab">
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5 class="card-title">Match History</h5>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <select id="role-filter" class="form-select">
                                        <option value="">All Roles</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select id="champion-filter" class="form-select">
                                        <option value="">All Champions</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" id="search-input" class="form-control" placeholder="Search by champion name...">
                                </div>
                            </div>
                             <div class="d-flex justify-content-end">
                                <button id="clear-filter-btn" class="btn btn-secondary btn-sm">Clear Filters</button>
                            </div>
                            <ul id="match-list" class="list-group mt-3">
                                <!-- Match history will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="mini-map" role="tabpanel" aria-labelledby="mini-map-tab">
                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-end mb-3">
                                <select id="mini-map-filter" class="form-select w-auto">
                                    <option value="199">All Games</option>
                                    <option value="10">Last 10 Games</option>
                                    <option value="20">Last 20 Games</option>
                                    <option value="35">Last 35 Games</option>
                                    <option value="50">Last 50 Games</option>
                                </select>
                            </div>
                            <div class="d-flex justify-content-center">
                                <div id="mini-map-container" style="position: relative;">
                                    <img src="mini-map.png" class="img-fluid" alt="Mini-map">
                                    <div id="mini-map-icons"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Details Modal -->
    <div class="modal fade" id="match-details-modal" tabindex="-1" aria-labelledby="matchDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchDetailsModalLabel">Match Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="match-details-body">
                    <!-- Match details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="match_list.js"></script>
    <script>
        const MATCHES_DIR = './matches/';
        const GAME_DATA_DIR = './game-data/';
        const PLAYER_DATA_DIR = './player-data/';

        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${url}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(error);
                return null;
            }
        }

        async function main() {
            const loadingEl = document.getElementById('loading');
            const contentEl = document.getElementById('content');

            // Fetch all data in parallel
            const [
                championData,
                itemData,
                gameModes,
                rankedInfo,
                championMastery,
                matches
            ] = await Promise.all([
                fetchData(`${GAME_DATA_DIR}champion.json`),
                fetchData(`${GAME_DATA_DIR}item.json`),
                fetchData(`${GAME_DATA_DIR}gameModes.json`),
                fetchData(`${PLAYER_DATA_DIR}rankedInfo.json`),
                fetchData(`${PLAYER_DATA_DIR}championMastery.json`),
                Promise.all(matchFiles.map(file => fetchData(`${MATCHES_DIR}${file}`)))
            ]);

            if (!matches.every(m => m)) {
                loadingEl.innerHTML = '<p class="text-danger">Error loading match data. Please check the console for details and make sure you are running this from a local web server.</p>';
                return;
            }
            
            matches.sort((a, b) => b.info.gameCreation - a.info.gameCreation);

            const masteryMap = new Map();
            if (championMastery) {
                championMastery.forEach(m => {
                    masteryMap.set(m.championId, { level: m.championLevel, points: m.championPoints });
                });
            }

            const allPuuids = matches.flatMap(match => match.metadata.participants);
            const puuidCounts = allPuuids.reduce((acc, puuid) => {
                acc[puuid] = (acc[puuid] || 0) + 1;
                return acc;
            }, {});

            const mainPlayerPuuid = Object.keys(puuidCounts).reduce((a, b) => puuidCounts[a] > puuidCounts[b] ? a : b);
            
            let mainPlayerName = '';
            const playerMatches = matches.map(match => {
                const playerParticipant = match.info.participants.find(p => p.puuid === mainPlayerPuuid);
                if (playerParticipant && !mainPlayerName) {
                    mainPlayerName = playerParticipant.riotIdGameName;
                }
                return { match, playerParticipant };
            }).filter(m => m.playerParticipant);

            // --- Populate UI ---
            document.getElementById('player-name').textContent = mainPlayerName;
            document.getElementById('total-games').textContent = playerMatches.length;

            const wins = playerMatches.filter(m => m.playerParticipant.win).length;
            const winRate = playerMatches.length > 0 ? (wins / playerMatches.length * 100).toFixed(2) : 0;
            document.getElementById('win-rate').textContent = `${winRate}%`;

            // Ranked Stats
            if (rankedInfo) {
                const rankedStatsEl = document.getElementById('ranked-stats');
                rankedInfo.forEach(queue => {
                    const queueType = queue.queueType.replace('RANKED_', '').replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
                    const rank = `${queue.tier} ${queue.rank}`;
                    const winLoss = `${queue.wins}W / ${queue.losses}L`;
                    const rankWinRate = queue.wins + queue.losses > 0 ? ((queue.wins / (queue.wins + queue.losses)) * 100).toFixed(2) : 0;

                    const col = document.createElement('div');
                    col.className = 'col-md-6';
                    col.innerHTML = `
                        <div class="card stat-card">
                            <div class="card-body">
                                <h5 class="card-title text-center">${queueType}</h5>
                                <div class="rank-crest-container" style="position: relative; width: 100px; height: 100px; margin: 0 auto;">
                                    <img src="Ranked%20Emblems%20Latest/Wings/${queue.tier}.png" class="wing" alt="Wing" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                                    <img src="Ranked%20Emblems%20Latest/Rank=${queue.tier}.png" class="rank-crest" alt="Rank Crest" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                                    <img src="Ranked%20Emblems%20Latest/Tier%20Wings/${queue.tier}.png" class="tier-wing" alt="Tier Wing" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                                </div>
                                <h6 class="card-subtitle mb-2 text-muted text-center">${rank} - ${queue.leaguePoints} LP</h6>
                                <p class="card-text text-center">${winLoss} (${rankWinRate}%)</p>
                            </div>
                        </div>
                    `;
                    rankedStatsEl.appendChild(col);
                });
            }

            // Role Performance
            const roleStats = {};
            playerMatches.forEach(({ playerParticipant }) => {
                const role = playerParticipant.teamPosition || 'UNKNOWN';
                if (!roleStats[role]) {
                    roleStats[role] = { games: 0, wins: 0, kills: 0, deaths: 0, assists: 0 };
                }
                roleStats[role].games++;
                if (playerParticipant.win) roleStats[role].wins++;
                roleStats[role].kills += playerParticipant.kills;
                roleStats[role].deaths += playerParticipant.deaths;
                roleStats[role].assists += playerParticipant.assists;
            });

            const roleFilter = document.getElementById('role-filter');
            Object.keys(roleStats).sort().forEach(role => {
                const option = document.createElement('option');
                option.value = role;
                option.textContent = role;
                roleFilter.appendChild(option);
            });

            // Role Distribution Chart
            const roleDistCtx = document.getElementById('role-distribution-chart').getContext('2d');
            new Chart(roleDistCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(roleStats),
                    datasets: [{
                        label: 'Games Played',
                        data: Object.values(roleStats).map(s => s.games),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ]
                    }]
                }
            });

            // Recent 20 Games Chart
            const last20Games = playerMatches.slice(0, 20).reverse();
            const chartLabels = last20Games.map((g, i) => `Game ${playerMatches.length - 19 + i}`);
            const chartData = last20Games.map(g => g.playerParticipant.win ? 1 : 0);
            
            const ctx = document.getElementById('win-loss-chart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Win/Loss (1 = Win, 0 = Loss)',
                        data: chartData,
                        backgroundColor: (context) => {
                            const value = context.dataset.data[context.dataIndex];
                            return value === 1 ? 'rgba(75, 192, 192, 0.2)' : 'rgba(255, 99, 132, 0.2)';
                        },
                        borderColor: (context) => {
                            const value = context.dataset.data[context.dataIndex];
                            return value === 1 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)';
                        },
                        borderWidth: 1,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value === 1 ? 'Win' : 'Loss';
                                }
                            }
                        }
                    }
                }
            });

            // Gold per Minute Trend
            const gpmTrendCtx = document.getElementById('gpm-trend-chart').getContext('2d');
            new Chart(gpmTrendCtx, {
                type: 'line',
                data: {
                    labels: last20Games.map((g, i) => `Game ${playerMatches.length - 19 + i}`),
                    datasets: [{
                        label: 'Gold per Minute',
                        data: last20Games.map(g => g.match.info.gameDuration > 0 ? g.playerParticipant.goldEarned / (g.match.info.gameDuration / 60) : 0),
                        borderColor: 'rgba(255, 206, 86, 1)',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        fill: true,
                    }]
                }
            });

            // Win Rate by Game Type
            const gameModeStats = {};
            playerMatches.forEach(({ match, playerParticipant }) => {
                const gameMode = match.info.gameMode;
                if (!gameModeStats[gameMode]) {
                    gameModeStats[gameMode] = { games: 0, wins: 0 };
                }
                gameModeStats[gameMode].games++;
                if (playerParticipant.win) {
                    gameModeStats[gameMode].wins++;
                }
            });

            const gamemodeWinrateCtx = document.getElementById('gamemode-winrate-chart').getContext('2d');
            new Chart(gamemodeWinrateCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(gameModeStats),
                    datasets: [{
                        label: 'Win Rate %',
                        data: Object.values(gameModeStats).map(s => (s.wins / s.games * 100).toFixed(2)),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Average Damage Composition
            let totalPhysicalDamage = 0;
            let totalMagicDamage = 0;
            let totalTrueDamage = 0;
            playerMatches.forEach(({ playerParticipant }) => {
                totalPhysicalDamage += playerParticipant.physicalDamageDealtToChampions;
                totalMagicDamage += playerParticipant.magicDamageDealtToChampions;
                totalTrueDamage += playerParticipant.trueDamageDealtToChampions;
            });

            const damageCompCtx = document.getElementById('damage-composition-chart').getContext('2d');
            new Chart(damageCompCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Physical Damage', 'Magic Damage', 'True Damage'],
                    datasets: [{
                        data: [totalPhysicalDamage, totalMagicDamage, totalTrueDamage],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ]
                    }]
                }
            });


            // Champion Stats Table
            const championStats = {};
            const championIdMap = new Map(Object.values(championData.data).map(c => [c.key, c]));

            playerMatches.forEach(({ playerParticipant }) => {
                const champId = playerParticipant.championId;
                if (!championStats[champId]) {
                    const champInfo = championIdMap.get(String(champId));
                    championStats[champId] = { 
                        id: champId,
                        name: playerParticipant.championName, 
                        image: champInfo ? champInfo.image.full : '',
                        games: 0, 
                        wins: 0, 
                        kills: 0, 
                        deaths: 0, 
                        assists: 0 
                    };
                }
                championStats[champId].games++;
                if (playerParticipant.win) championStats[champId].wins++;
                championStats[champId].kills += playerParticipant.kills;
                championStats[champId].deaths += playerParticipant.deaths;
                championStats[champId].assists += playerParticipant.assists;
            });
            let championStatsArray = Object.values(championStats);

            // Top 5 Champs by Win Rate Chart
            const topChampsByWinRate = [...championStatsArray]
                .filter(c => c.games >= 5) // Filter for champs with a decent number of games
                .sort((a, b) => (b.wins / b.games) - (a.wins / a.games))
                .slice(0, 5);

            const topChampsWinRateCtx = document.getElementById('top-champs-winrate-chart').getContext('2d');
            new Chart(topChampsWinRateCtx, {
                type: 'bar',
                data: {
                    labels: topChampsByWinRate.map(c => c.name),
                    datasets: [{
                        label: 'Win Rate %',
                        data: topChampsByWinRate.map(c => (c.wins / c.games * 100).toFixed(2)),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Top 5 Champs by KDA Chart
            const topChampsByKDA = [...championStatsArray]
                .filter(c => c.games >= 5)
                .sort((a, b) => {
                    const kdaA = a.deaths > 0 ? (a.kills + a.assists) / a.deaths : Infinity;
                    const kdaB = b.deaths > 0 ? (b.kills + b.assists) / b.deaths : Infinity;
                    return kdaB - kdaA;
                })
                .slice(0, 5);

            const topChampsKdaCtx = document.getElementById('top-champs-kda-chart').getContext('2d');
            new Chart(topChampsKdaCtx, {
                type: 'bar',
                data: {
                    labels: topChampsByKDA.map(c => c.name),
                    datasets: [{
                        label: 'Average KDA',
                        data: topChampsByKDA.map(c => (c.deaths > 0 ? (c.kills + c.assists) / c.deaths : Infinity).toFixed(2)),
                        backgroundColor: 'rgba(153, 102, 255, 0.7)'
                    }]
                },
                options: {
                    indexAxis: 'y'
                }
            });

            const miniMapIconsEl = document.getElementById('mini-map-icons');
            const miniMapFilter = document.getElementById('mini-map-filter');
            const rolePaths = {
                blue: {
                    // bot-left to top-left → move up (y ↓), x stays low
                    TOP:     { origin: { x: 15, y: 85 }, vector: { x: 0, y: -60 }, spread: 0.8, jitter: 4 },

                    // top-side jungle → upper triangle near mid/top
                    JUNGLE:  { origin: { x: 35, y: 40 }, radiusX: 12, radiusY: 12 },

                    // bot-left to center → move up-right
                    MIDDLE:  { origin: { x: 20, y: 80 }, vector: { x: 30, y: -30 }, spread: 1, jitter: 3 },

                    // bot-left to bot-right → y constant, x increases
                    BOTTOM:  { origin: { x: 25, y: 95 }, vector: { x: 50, y: 0 }, spread: 0.7, jitter: 4 },
                    UTILITY: { origin: { x: 30, y: 95 }, vector: { x: 50, y: 0 }, spread: 0.7, jitter: 4 },

                    // top-left to center → x and y both increase
                    UNKNOWN: { origin: { x: 20, y: 20 }, radiusX: 6, radiusY: 10 }
                },

                red: {
                    // top-right to top-left → y constant, x decreases
                    TOP:     { origin: { x: 85, y: 15 }, vector: { x: -60, y: 0 }, spread: 0.8, jitter: 4 },

                    // bot-side jungle → bottom triangle near mid/bot
                    JUNGLE:  { origin: { x: 65, y: 60 }, radiusX: 12, radiusY: 12 },

                    // top-right to center → x and y decrease
                    MIDDLE:  { origin: { x: 80, y: 20 }, vector: { x: -30, y: 30 }, spread: 1, jitter: 3 },

                    // top-right to bot-right → x constant, y increases
                    BOTTOM:  { origin: { x: 95, y: 25 }, vector: { x: 0, y: 50 }, spread: 0.7, jitter: 4 },
                    UTILITY: { origin: { x: 95, y: 30 }, vector: { x: 0, y: 50 }, spread: 0.7, jitter: 4 },

                    // bot-right to center → x and y decrease
                    UNKNOWN: { origin: { x: 80, y: 80 }, radiusX: 6, radiusY: 10 }
                }
            };

            function renderMiniMap(gamesToShow) {
                miniMapIconsEl.innerHTML = '';
                const matchesToRender = playerMatches.slice(0, gamesToShow);
                
                const matchesByRole = { TOP: [], JUNGLE: [], MIDDLE: [], BOTTOM: [], UTILITY: [], UNKNOWN: [] };
                matchesToRender.forEach(match => {
                    const role = match.playerParticipant.teamPosition || 'UNKNOWN';
                    if (matchesByRole[role]) {
                        matchesByRole[role].push(match);
                    }
                });

                for (const role in matchesByRole) {
                    const gamesInRole = matchesByRole[role];
                    if (gamesInRole.length === 0) continue;

                    gamesInRole.forEach((matchData, index) => {
                        const { playerParticipant } = matchData;
                        const teamId = playerParticipant.teamId;
                        const team = teamId === 100 ? 'blue' : 'red';
                        const pathOrBox = rolePaths[team][role];

                        let posX, posY;

                        if (pathOrBox.vector) { // It's a lane with a vector
                            const t = gamesInRole.length > 1 ? index / (gamesInRole.length - 1) : 0.5;
                            posX = pathOrBox.origin.x + t * pathOrBox.vector.x * pathOrBox.spread;
                            posY = pathOrBox.origin.y + t * pathOrBox.vector.y * pathOrBox.spread;

                            // Add perpendicular jitter
                            const perpVector = { x: -pathOrBox.vector.y, y: pathOrBox.vector.x };
                            const norm = Math.sqrt(perpVector.x * perpVector.x + perpVector.y * perpVector.y);
                            if (norm > 0) {
                                const normalizedPerp = { x: perpVector.x / norm, y: perpVector.y / norm };
                                const jitterAmount = (Math.random() - 0.5) * pathOrBox.jitter;
                                posX += normalizedPerp.x * jitterAmount;
                                posY += normalizedPerp.y * jitterAmount;
                            }

                        } else if (pathOrBox.radiusX) { // It's a box (Jungle/Unknown)
                            posX = pathOrBox.origin.x + (Math.random() - 0.5) * 2 * pathOrBox.radiusX;
                            posY = pathOrBox.origin.y + (Math.random() - 0.5) * 2 * pathOrBox.radiusY;
                        }


                        const champName = playerParticipant.championName;
                        const champIconUrl = `https://ddragon.leagueoflegends.com/cdn/${championData.version}/img/champion/${champName}.png`;

                        const icon = document.createElement('img');
                        icon.src = champIconUrl;
                        icon.title = `${champName} (${role})`;
                        icon.className = 'champion-icon-map';
                        icon.style.left = `${posX}%`;
                        icon.style.top = `${posY}%`;
                        icon.style.borderColor = team === 'blue' ? '#007bff' : '#dc3545';

                        miniMapIconsEl.appendChild(icon);
                    });
                }
            }

            miniMapFilter.addEventListener('change', (e) => {
                renderMiniMap(parseInt(e.target.value, 10));
            });

            // Initial render
            renderMiniMap(199);
            const championFilter = document.getElementById('champion-filter');

            function renderChampionStats(sortKey = 'games', sortOrder = 'desc') {
                const championStatsTable = document.getElementById('champion-stats-table');
                championStatsTable.innerHTML = '';

                championStatsArray.sort((a, b) => {
                    let valA, valB;
                    if (sortKey === 'name') {
                        valA = a.name;
                        valB = b.name;
                    } else if (sortKey === 'winRate') {
                        valA = a.wins / a.games;
                        valB = b.wins / b.games;
                    } else if (sortKey === 'kda') {
                        valA = a.deaths > 0 ? (a.kills + a.assists) / a.deaths : Infinity;
                        valB = b.deaths > 0 ? (b.kills + b.assists) / b.deaths : Infinity;
                    } else if (sortKey === 'masteryLevel' || sortKey === 'masteryPoints') {
                        const masteryA = masteryMap.get(a.id) || { level: 0, points: 0 };
                        const masteryB = masteryMap.get(b.id) || { level: 0, points: 0 };
                        valA = sortKey === 'masteryLevel' ? masteryA.level : masteryA.points;
                        valB = sortKey === 'masteryLevel' ? masteryB.level : masteryB.points;
                    } else {
                        valA = a[sortKey];
                        valB = b[sortKey];
                    }

                    if (typeof valA === 'string') {
                        return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return sortOrder === 'asc' ? valA - valB : valB - valA;
                });

                championStatsArray.forEach(champ => {
                    const champMastery = masteryMap.get(champ.id);
                    const champWinRate = (champ.wins / champ.games * 100).toFixed(2);
                    const avgKills = (champ.kills / champ.games).toFixed(1);
                    const avgDeaths = (champ.deaths / champ.games).toFixed(1);
                    const avgAssists = (champ.assists / champ.games).toFixed(1);
                    const kda = avgDeaths > 0 ? ((parseFloat(avgKills) + parseFloat(avgAssists)) / parseFloat(avgDeaths)).toFixed(2) : 'Perfect';
                    const champIconUrl = `https://ddragon.leagueoflegends.com/cdn/${championData.version}/img/champion/${champ.image}`;

                    const row = document.createElement('tr');
                    row.className = 'clickable-row';
                    row.innerHTML = `
                        <td><img src="${champIconUrl}" class="champion-icon me-2"> ${champ.name}</td>
                        <td>${champ.games}</td>
                        <td>${champWinRate}%</td>
                        <td>${kda}</td>
                        <td>${champMastery ? champMastery.level : 'N/A'}</td>
                        <td>${champMastery ? champMastery.points.toLocaleString() : 'N/A'}</td>
                    `;
                    row.addEventListener('click', () => applyFilters({ champion: champ.name }));
                    championStatsTable.appendChild(row);
                });
            }

            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    const currentOrder = header.dataset.order || 'desc';
                    const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
                    header.dataset.order = newOrder;

                    document.querySelectorAll('.sortable-header i').forEach(i => i.className = 'bi bi-sort-down');
                    header.querySelector('i').className = newOrder === 'desc' ? 'bi bi-sort-down' : 'bi bi-sort-up';
                    if (sortKey === 'name') {
                        header.querySelector('i').className = newOrder === 'desc' ? 'bi bi-sort-alpha-down' : 'bi bi-sort-alpha-up';
                    }

                    renderChampionStats(sortKey, newOrder);
                });
            });
            
            championStatsArray.forEach(champ => {
                const option = document.createElement('option');
                option.value = champ.name;
                option.textContent = champ.name;
                championFilter.appendChild(option);
            });

            renderChampionStats();


            // Match History List
            const matchListEl = document.getElementById('match-list');
            const searchInput = document.getElementById('search-input');
            const clearFilterBtn = document.getElementById('clear-filter-btn');

            function renderMatchList(filters = {}) {
                matchListEl.innerHTML = '';
                let filteredMatches = playerMatches;

                if (filters.champion) {
                    filteredMatches = filteredMatches.filter(({ playerParticipant }) => playerParticipant.championName.toLowerCase() === filters.champion.toLowerCase());
                }
                if (filters.role) {
                    filteredMatches = filteredMatches.filter(({ playerParticipant }) => (playerParticipant.teamPosition || 'UNKNOWN') === filters.role);
                }
                if (filters.search) {
                    filteredMatches = filteredMatches.filter(({ playerParticipant }) => playerParticipant.championName.toLowerCase().includes(filters.search.toLowerCase()));
                }

                filteredMatches.forEach(({ match, playerParticipant }) => {
                    const li = document.createElement('li');
                    li.className = `list-group-item d-flex justify-content-between align-items-center match-list-item ${playerParticipant.win ? 'list-group-item-success' : 'list-group-item-danger'}`;
                    li.innerHTML = `
                        <div>
                            <strong>${playerParticipant.championName}</strong> (${playerParticipant.teamPosition || 'N/A'})
                            <small class="d-block">${new Date(match.info.gameCreation).toLocaleString()}</small>
                        </div>
                        <div>KDA: ${playerParticipant.kills}/${playerParticipant.deaths}/${playerParticipant.assists}</div>
                    `;
                    li.addEventListener('click', () => showMatchDetails(match, mainPlayerPuuid, championData, itemData, gameModes));
                    matchListEl.appendChild(li);
                });
            }

            let currentFilters = {};
            function applyFilters(newFilters) {
                currentFilters = { ...currentFilters, ...newFilters };
                roleFilter.value = currentFilters.role || '';
                championFilter.value = currentFilters.champion || '';
                searchInput.value = currentFilters.search || '';
                renderMatchList(currentFilters);
            }

            searchInput.addEventListener('input', (e) => applyFilters({ search: e.target.value }));
            roleFilter.addEventListener('change', (e) => applyFilters({ role: e.target.value }));
            championFilter.addEventListener('change', (e) => applyFilters({ champion: e.target.value }));

            clearFilterBtn.addEventListener('click', () => {
                currentFilters = {};
                applyFilters(currentFilters);
            });

            renderMatchList();

            loadingEl.classList.add('d-none');
            contentEl.classList.remove('d-none');
        }

        function showMatchDetails(match, mainPlayerPuuid, championData, itemData, gameModes) {
            const modalBody = document.getElementById('match-details-body');
            const teams = { 100: [], 200: [] };
            match.info.participants.forEach(p => teams[p.teamId].push(p));

            const gameModeInfo = gameModes.find(gm => gm.gameMode === match.info.gameMode);
            const modalTitle = document.getElementById('matchDetailsModalLabel');
            modalTitle.textContent = `Match Details - ${gameModeInfo ? gameModeInfo.description : match.info.gameMode}`;

            const itemVersion = itemData.version;
            const championVersion = championData.version;
            const championIdMap = new Map(Object.values(championData.data).map(c => [c.key, c]));

            const getItemUrl = (itemId) => {
                if (!itemId || !itemData.data[itemId]) return 'https://via.placeholder.com/32';
                const item = itemData.data[itemId];
                return `https://ddragon.leagueoflegends.com/cdn/${itemVersion}/img/item/${item.image.full}`;
            };

            const getChampionIconUrl = (championId) => {
                const champInfo = championIdMap.get(String(championId));
                if (!champInfo) return 'https://via.placeholder.com/32';
                return `https://ddragon.leagueoflegends.com/cdn/${championVersion}/img/champion/${champInfo.image.full}`;
            }

            const renderTeam = (team) => {
                return team.map(p => {
                    const isMainPlayer = p.puuid === mainPlayerPuuid;
                    const items = [p.item0, p.item1, p.item2, p.item3, p.item4, p.item5, p.item6]
                                .filter(id => id !== 0)
                                .map(id => `<img src="${getItemUrl(id)}" class="item-icon" title="${itemData.data[id]?.name || 'Unknown Item'}">`)
                                .join('');
                    const champIconUrl = getChampionIconUrl(p.championId);

                    return `
                        <tr class="${isMainPlayer ? 'table-info' : ''}">
                            <td><img src="${champIconUrl}" class="champion-icon me-2" alt="${p.championName}">${p.riotIdGameName}</td>
                            <td>${p.kills}/${p.deaths}/${p.assists}</td>
                            <td>${p.totalDamageDealtToChampions.toLocaleString()}</td>
                            <td>${p.goldEarned.toLocaleString()}</td>
                            <td>${items}</td>
                        </tr>
                    `;
                }).join('');
            };

            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-lg-6">
                        <h5 class="text-primary">Blue Team ${match.info.teams[0].win ? '(Win)' : ''}</h5>
                        <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>Player</th><th>KDA</th><th>Damage</th><th>Gold</th><th>Items</th></tr></thead>
                            <tbody>${renderTeam(teams[100])}</tbody>
                        </table>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <h5 class="text-danger">Red Team ${match.info.teams[1].win ? '(Win)' : ''}</h5>
                        <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>Player</th><th>KDA</th><th>Damage</th><th>Gold</th><th>Items</th></tr></thead>
                            <tbody>${renderTeam(teams[200])}</tbody>
                        </table>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('match-details-modal'));
            modal.show();
        }

        main();
    </script>
</body>
</html>
